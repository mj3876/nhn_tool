<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í• ì¼ ëª©ë¡</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <h1>âœ… í• ì¼ ëª©ë¡</h1>
        
        <div class="nav">
            <a href="{{ url_for('index') }}" class="nav-btn">ğŸ  í™ˆ</a>
        </div>
        
        <div style="max-width: 800px; margin: 30px auto;">
            <!-- ì•Œë¦¼ ì„¤ì • ì•ˆë‚´ -->
            <div id="notification-setup" style="background: #fff3cd; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: none;">
                <p style="margin: 0; color: #856404;">
                    âš ï¸ <strong>ì•Œë¦¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤!</strong><br>
                    ì•ŒëŒ ì†Œë¦¬ë¥¼ ë“¤ìœ¼ë ¤ë©´ ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•´ì„œ ì•Œë¦¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.
                </p>
                <button onclick="requestNotificationPermission()" class="btn btn-primary" style="margin-top: 10px;">
                    ğŸ”” ì•Œë¦¼ ê¶Œí•œ í—ˆìš©í•˜ê¸°
                </button>
            </div>
            
            <!-- ì•Œë¦¼ ìƒíƒœ í‘œì‹œ -->
            <div id="notification-status" style="background: #d4edda; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: none;">
                <p style="margin: 0; color: #155724;">
                    âœ… ì•Œë¦¼ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤! ì„¤ì •í•œ ì‹œê°„ì— ì†Œë¦¬ì™€ í•¨ê»˜ ì•ŒëŒì´ ìš¸ë¦½ë‹ˆë‹¤.
                </p>
            </div>
            
            <form method="POST" action="{{ url_for('todos_add') }}" style="background: #f8f9fa; padding: 25px; border-radius: 10px; margin-bottom: 30px;">
                <h3 style="margin-bottom: 20px; color: #667eea;">ìƒˆ í• ì¼ ì¶”ê°€</h3>
                
                <div class="form-group">
                    <label for="title">í• ì¼</label>
                    <input type="text" id="title" name="title" placeholder="ë¬´ì—‡ì„ í• ê¹Œìš”?" required>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="date">ë‚ ì§œ</label>
                        <input type="date" id="date" name="date" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="time">ì‹œê°„ (ì•ŒëŒ)</label>
                        <input type="time" id="time" name="time">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="type">ìœ í˜•</label>
                    <select id="type" name="type" required>
                        <option value="daily">í•˜ë£¨ í• ì¼</option>
                        <option value="monthly">í•œ ë‹¬ í• ì¼</option>
                    </select>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 12px;">
                    â• ì¶”ê°€í•˜ê¸°
                </button>
            </form>
            
            <h2>ğŸ“‹ í• ì¼ ëª©ë¡</h2>
            
            {% if todos %}
            <div>
                {% for todo in todos %}
                <div class="todo-item {% if todo.completed %}completed{% endif %}">
                    <div>
                        <strong>{{ todo.title }}</strong><br>
                        <small style="color: #999;">
                            ğŸ“… {{ todo.date }} 
                            {% if todo.time %}â° {{ todo.time }}{% endif %}
                            <span style="background: {% if todo.type == 'daily' %}#28a745{% else %}#007bff{% endif %}; color: white; padding: 2px 8px; border-radius: 3px; font-size: 0.8em;">
                                {{ 'í•˜ë£¨' if todo.type == 'daily' else 'í•œë‹¬' }}
                            </span>
                        </small>
                    </div>
                    <div>
                        <a href="{{ url_for('todos_toggle', todo_id=todo.id) }}" class="btn btn-success">
                            {% if todo.completed %}âœ“{% else %}â—‹{% endif %}
                        </a>
                        <a href="{{ url_for('todos_delete', todo_id=todo.id) }}" 
                           class="btn btn-danger"
                           onclick="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">ì‚­ì œ</a>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div style="text-align: center; padding: 50px; color: #999;">
                ì•„ì§ ë“±ë¡ëœ í• ì¼ì´ ì—†ìŠµë‹ˆë‹¤.
            </div>
            {% endif %}
        </div>
    </div>
    
    <script>
        // ê¸°ë³¸ ë‚ ì§œë¥¼ ì˜¤ëŠ˜ë¡œ ì„¤ì •
        document.getElementById('date').value = new Date().toISOString().split('T')[0];
        
        // ì•ŒëŒ ì†Œë¦¬ ìƒì„± (Web Audio API ì‚¬ìš©)
        let audioContext = null;
        let alarmSound = null;
        
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }
        
        // ì•ŒëŒ ì†Œë¦¬ ì¬ìƒ
        function playAlarmSound() {
            initAudio();
            
            // ë¹„í”„ìŒ 3ë²ˆ ì¬ìƒ
            for (let i = 0; i < 3; i++) {
                setTimeout(() => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = 800; // ì£¼íŒŒìˆ˜ (Hz)
                    oscillator.type = 'sine'; // ì†Œë¦¬ íƒ€ì…
                    
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.5);
                }, i * 600);
            }
            
            // ì§„ë™ (ì•ˆë“œë¡œì´ë“œ ì§€ì›)
            if (navigator.vibrate) {
                navigator.vibrate([200, 100, 200, 100, 200]);
            }
        }
        
        // ì•Œë¦¼ ê¶Œí•œ ìš”ì²­
        function requestNotificationPermission() {
            if ('Notification' in window) {
                Notification.requestPermission().then(permission => {
                    updateNotificationStatus();
                    if (permission === 'granted') {
                        alert('ì•Œë¦¼ ê¶Œí•œì´ í—ˆìš©ë˜ì—ˆìŠµë‹ˆë‹¤! âœ…');
                    }
                });
            }
        }
        
        // ì•Œë¦¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateNotificationStatus() {
            const setupDiv = document.getElementById('notification-setup');
            const statusDiv = document.getElementById('notification-status');
            
            if ('Notification' in window) {
                if (Notification.permission === 'default') {
                    setupDiv.style.display = 'block';
                    statusDiv.style.display = 'none';
                } else if (Notification.permission === 'granted') {
                    setupDiv.style.display = 'none';
                    statusDiv.style.display = 'block';
                } else {
                    setupDiv.style.display = 'none';
                    statusDiv.style.display = 'none';
                }
            }
        }
        
        // í• ì¼ ì•ŒëŒ í™•ì¸
        function checkTodoAlarms() {
            fetch('/api/todos/today')
                .then(response => response.json())
                .then(todos => {
                    const now = new Date();
                    const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                    
                    todos.forEach(todo => {
                        if (todo.time === currentTime && !todo.completed) {
                            // ì•ŒëŒ ì†Œë¦¬ ì¬ìƒ
                            playAlarmSound();
                            
                            // ë¸Œë¼ìš°ì € ì•Œë¦¼ í‘œì‹œ
                            if (Notification.permission === "granted") {
                                const notification = new Notification('í• ì¼ ì•Œë¦¼ â°', {
                                    body: todo.title,
                                    icon: '/static/icon.png',
                                    badge: '/static/badge.png',
                                    vibrate: [200, 100, 200],
                                    requireInteraction: true, // ì‚¬ìš©ìê°€ ë‹«ì„ ë•Œê¹Œì§€ ìœ ì§€
                                    tag: 'todo-' + todo.id // ì¤‘ë³µ ì•Œë¦¼ ë°©ì§€
                                });
                                
                                // ì•Œë¦¼ í´ë¦­ ì‹œ í• ì¼ í˜ì´ì§€ë¡œ ì´ë™
                                notification.onclick = function() {
                                    window.focus();
                                    notification.close();
                                };
                            }
                        }
                    });
                });
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        window.addEventListener('load', function() {
            updateNotificationStatus();
            initAudio();
            
            // ì´ˆê¸° ì•ŒëŒ í™•ì¸
            checkTodoAlarms();
        });
        
        // 1ë¶„ë§ˆë‹¤ ì•ŒëŒ í™•ì¸
        setInterval(checkTodoAlarms, 60000);
        
        // ì‚¬ìš©ì ì¸í„°ë™ì…˜ ì‹œ ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ í™œì„±í™” (ì•ˆë“œë¡œì´ë“œ ì •ì±…)
        document.addEventListener('click', function() {
            if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }, { once: true });
    </script>
</body>
</html>